import requests
import pandas as pd
import os

TOKEN = os.getenv('TELEGRAM_TOKEN')
CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

def enviar_telegram(mensagem):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage?chat_id={CHAT_ID}&text={mensagem}&parse_mode=Markdown"
    requests.get(url)

def executar():
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        res = requests.get("https://www.praticagem.org.br/manobras-previstas.html", headers=headers, timeout=20)
        df = pd.read_html(res.text)[0]
        
        sul = df[df['BerÃ§o'].str.contains('TUBP1S', na=False, case=False)]
        norte = df[df['BerÃ§o'].str.contains('TUBP1N', na=False, case=False)]

        def analisar_berco(dados, nome):
            if dados.empty:
                return f"âš“ *BerÃ§o {nome}:* ğŸŸ¢ *LIVRE*\nğŸ“‹ _Sem programaÃ§Ã£o prÃ³xima._\n"

            # LÃ³gica corrigida: 
            # Se a primeira manobra da lista for "SAÃDA", o navio estÃ¡ lÃ¡ agora (OCUPADO).
            # Se for "ENTRADA", o berÃ§o estÃ¡ vago aguardando o navio (LIVRE).
            primeira_manobra = dados.iloc[0]['Manobra'].upper()
            navio_atual = dados.iloc[0]['Navio']
            
            if "SAÃDA" in primeira_manobra or "SAIDA" in primeira_manobra:
                status = f"ğŸ”´ *OCUPADO* (Navio: {navio_atual})"
            else:
                status = "ğŸŸ¢ *LIVRE*"

            info = f"âš“ *BerÃ§o {nome}:* {status}\n"
            
            # ProgramaÃ§Ã£o Futura (prÃ³ximas linhas)
            if len(dados) > 0:
                info += "ğŸ“‹ _Prog. Futura:_\n"
                for _, r in dados.head(3).iterrows():
                    info += f"  â€¢ {r['Navio']} ({r['Manobra']})\n"
            return info

        report = "ğŸ“‹ *REPORT TÃ‰CNICO - PIER 1*\n\n"
        report += analisar_berco(sul, "SUL (P1S)")
        report += "\n"
        report += analisar_berco(norte, "NORTE (P1N)")
        
        enviar_telegram(report)

    except Exception as e:
        enviar_telegram(f"âš ï¸ *Erro na extraÃ§Ã£o:* {str(e)}")

if __name__ == "__main__":
    executar()